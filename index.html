<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pupilometer Pro V7 - Stats & Safety</title>
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base Styles --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        * { box-sizing: border-box; }

        /* --- Top Bar --- */
        .top-bar {
            background: #fff; border-bottom: 1px solid #ccc; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 10;
        }
        .app-title { font-weight: 800; font-size: 1.2em; color: #2c3e50; letter-spacing: -0.5px; }
        
        .mode-tabs { display: flex; background: #e9ecef; padding: 4px; border-radius: 6px; }
        .tab-btn {
            border: none; background: transparent; padding: 6px 16px; font-weight: 600; color: #666; cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 0.9em;
        }
        .tab-btn.active { background: #fff; color: #007bff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .gen-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 6px;}
        .gen-btn:hover { background: #218838; }

        /* --- Layout --- */
        .main-container { display: flex; flex: 1; height: calc(100vh - 60px); }

        /* --- Sidebar --- */
        .sidebar {
            width: 340px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column;
            overflow-y: auto; padding: 15px; gap: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 5;
        }

        /* Panels */
        .panel { border: 1px solid #eee; padding: 12px; border-radius: 8px; background: #fcfcfc; flex-shrink: 0; }
        .panel-label { font-size: 0.75em; font-weight: 700; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; }
        
        /* Summary Box */
        .summary-box { background: #e3f2fd; border: 1px solid #90caf9; }
        .sum-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 4px; color: #333; }
        .sum-final { border-top: 1px solid #90caf9; margin-top: 8px; padding-top: 8px; font-weight: 800; color: #d32f2f; font-size: 1.1em; }

        /* Tools */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .tool-btn { 
            padding: 8px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: 500;
        }
        .tool-btn:hover { background: #f8f9fa; }
        .tool-btn.active { background: #007bff; color: white; border-color: #0056b3; }
        .file-btn { width: 100%; background: #fff; border: 2px dashed #ccc; color: #666; }
        .file-btn:hover { border-color: #007bff; color: #007bff; }

        /* Image Adjustments */
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.85em; color: #555; }
        .slider-row input { flex: 1; }
        .slider-val { width: 35px; text-align: right; font-family: monospace; }

        /* Footer / Disclaimer */
        .sidebar-footer {
            margin-top: auto; padding-top: 20px; border-top: 1px solid #eee;
        }
        .disclaimer-text {
            font-size: 10px; color: #999; line-height: 1.4; text-align: justify;
            margin-bottom: 10px;
        }
        .stats-link {
            font-size: 10px; color: #bbb; text-align: center; cursor: pointer; text-decoration: none; display: block;
        }
        .stats-link:hover { text-decoration: underline; color: #007bff; }

        /* Canvas */
        .canvas-wrapper { flex: 1; position: relative; background: #222; overflow: hidden; cursor: crosshair; }
        .canvas-tip { position: absolute; bottom: 15px; right: 20px; color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none; user-select: none; }

        /* Modals (Report & Stats) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 210mm; height: 90vh; padding: 40px; 
            overflow-y: auto; border-radius: 4px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Stats Specific Modal */
        .stats-content { width: 600px; height: auto; max-height: 90vh; padding: 30px; }

        /* Print Styles */
        @media print {
            body > * { display: none !important; }
            .modal-overlay { display: block !important; position: absolute; background: white; top: 0; left: 0; width: 100%; height: auto; }
            .modal-content { width: 100%; height: auto; padding: 0; overflow: visible; box-shadow: none; }
            .no-print { display: none !important; }
            img { -webkit-print-color-adjust: exact; }
            /* Hide stats modal during print if accidentally open */
            #statsModal { display: none !important; }
        }

        /* Report Internal */
        .rpt-header { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .rpt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .rpt-box { border: 1px solid #ddd; padding: 10px; border-radius: 4px; break-inside: avoid; }
        .rpt-img { width: 100%; height: 250px; border: 1px solid #eee; margin-bottom: 10px; object-fit: contain; background: #fafafa; }
        .rpt-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .rpt-table th, .rpt-table td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .rpt-summ { background: #f9f9f9; padding: 15px; border: 2px solid #333; border-radius: 6px; break-inside: avoid; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="app-title">üëÅÔ∏è Pupilometer Cloud</div>
    
    <div class="mode-tabs">
        <button class="tab-btn active" onclick="switchTab('light')" id="tab-light">‚òÄÔ∏è Light Room</button>
        <button class="tab-btn" onclick="switchTab('dark')" id="tab-dark">üåô Dark Room</button>
    </div>

    <div style="display:flex; gap:15px; align-items:center;">
        <div style="font-size:0.9em; color:#555;">
            Ref Cornea: <input type="number" id="refCornea" value="12.0" step="0.1" style="width:55px; padding:4px; border:1px solid #ccc; border-radius:4px;" onchange="recalcAll()"> mm
        </div>
        <button class="gen-btn" onclick="openReport()">üñ®Ô∏è Generate Report</button>
    </div>
</div>

<div class="main-container">
    <div class="sidebar">
        
        <!-- Summary -->
        <div class="panel summary-box">
            <div class="panel-label" style="color:#1565c0; border-bottom:none;">Diagnostic Summary</div>
            <div class="sum-row"><span>Dark Anisocoria:</span><span id="glb-dark">-</span></div>
            <div class="sum-row"><span>Light Anisocoria:</span><span id="glb-light">-</span></div>
            <div class="sum-row sum-final"><span>Diff (Dark - Light):</span><span id="glb-final">-</span></div>
        </div>

        <!-- Image Upload -->
        <div class="panel">
            <div class="panel-label">
                <span>1. Image Source</span>
                <span id="img-status" style="font-weight:400; color:#28a745; display:none;">‚óè Loaded</span>
            </div>
            <button class="tool-btn file-btn" onclick="document.getElementById('fileInput').click()">üìÇ Upload Photo / Paste (Ctrl+V)</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>

        <!-- Image Adjustments -->
        <div class="panel">
            <div class="panel-label">
                <span>2. Image Enhancer</span>
                <span style="font-weight:400; cursor:pointer; color:#007bff;" onclick="resetFilters()">Reset</span>
            </div>
            <div class="slider-row">
                <span>Brightness</span>
                <input type="range" id="slider-br" min="0" max="200" value="100" oninput="updateFilters()">
                <span class="slider-val" id="val-br">100</span>%
            </div>
            <div class="slider-row">
                <span>Contrast</span>
                <input type="range" id="slider-ct" min="0" max="200" value="100" oninput="updateFilters()">
                <span class="slider-val" id="val-ct">100</span>%
            </div>
        </div>

        <!-- Tools -->
        <div class="panel">
            <div class="panel-label">3. Measurements (OD Right)</div>
            <div class="btn-grid">
                <button class="tool-btn" onclick="setTool('r_cornea')" id="btn-r-cornea">Cornea</button>
                <button class="tool-btn" onclick="setTool('r_pupil')" id="btn-r-pupil">Pupil</button>
            </div>
            <div class="panel-label" style="margin-top:10px;">4. Measurements (OS Left)</div>
            <div class="btn-grid">
                <button class="tool-btn" onclick="setTool('l_cornea')" id="btn-l-cornea">Cornea</button>
                <button class="tool-btn" onclick="setTool('l_pupil')" id="btn-l-pupil">Pupil</button>
            </div>
        </div>

        <!-- Local Result -->
        <div class="panel">
            <div class="panel-label">Current Tab Results</div>
            <div class="sum-row"><span>R Pupil:</span><span id="loc-r">-</span></div>
            <div class="sum-row"><span>L Pupil:</span><span id="loc-l">-</span></div>
            <div class="sum-row" style="font-weight:bold; margin-top:5px; padding-top:5px; border-top:1px dashed #ddd;">
                <span>Diff:</span><span id="loc-diff">-</span>
            </div>
        </div>

        <!-- Sidebar Footer: Disclaimer & Stats -->
        <div class="sidebar-footer">
            <div class="disclaimer-text">
                <strong>Disclaimer:</strong> This software is designed as an adjunctive tool for clinical reference and educational purposes only. It is not a certified medical device and has not been cleared by regulatory bodies for diagnostic use. Measurements should not be the sole basis for clinical decision-making. The user assumes all responsibility for data interpretation and patient care. Accuracy is dependent on image quality and calibration.
            </div>
            <div class="stats-link" onclick="openStats()">
                Usage Statistics ‚Ä¢ Total Visits: <span id="lbl-visits">Loading...</span>
            </div>
        </div>
    </div>

    <div class="canvas-wrapper" id="canvasContainer">
        <canvas id="mainCanvas"></canvas>
        <div class="canvas-tip">Scroll: Zoom ‚Ä¢ Right-Click: Pan ‚Ä¢ Left-Click: Measure</div>
    </div>
</div>

<!-- REPORT MODAL -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div style="position:absolute; top:20px; right:20px;" class="no-print">
            <button class="gen-btn" onclick="window.print()" style="display:inline-flex;">üñ®Ô∏è Print PDF</button>
            <button class="tool-btn" onclick="document.getElementById('reportModal').style.display='none'" style="margin-left:10px;">Close</button>
        </div>

        <div class="rpt-header">
            <div>
                <h1 style="margin:0; color:#2c3e50;">Pupilometry Report</h1>
                <p style="margin:5px 0; color:#666;">Analysis Protocol: Dual Illumination</p>
            </div>
            <div style="text-align:right; font-size:14px; color:#555;">
                Generated: <span id="rpt-date"></span><br>
                Reference: <span id="rpt-ref"></span> mm
            </div>
        </div>

        <div class="rpt-grid">
            <!-- Light -->
            <div class="rpt-box">
                <h3 style="margin-top:0; border-bottom:1px solid #eee;">‚òÄÔ∏è Light Room</h3>
                <img id="rpt-img-light" class="rpt-img">
                <table class="rpt-table">
                    <tr><th>Right Pupil (OD)</th><th>Left Pupil (OS)</th><th>Anisocoria</th></tr>
                    <tr><td id="rpt-l-r">-</td><td id="rpt-l-l">-</td><td id="rpt-l-diff" style="font-weight:bold">-</td></tr>
                </table>
            </div>
            <!-- Dark -->
            <div class="rpt-box">
                <h3 style="margin-top:0; border-bottom:1px solid #eee;">üåô Dark Room</h3>
                <img id="rpt-img-dark" class="rpt-img">
                <table class="rpt-table">
                    <tr><th>Right Pupil (OD)</th><th>Left Pupil (OS)</th><th>Anisocoria</th></tr>
                    <tr><td id="rpt-d-r">-</td><td id="rpt-d-l">-</td><td id="rpt-d-diff" style="font-weight:bold">-</td></tr>
                </table>
            </div>
        </div>

        <div class="rpt-summ">
            <h3 style="margin-top:0; text-decoration:underline;">Diagnostic Conclusion</h3>
            <div class="sum-row" style="font-size:1.1em; margin-bottom:8px;">
                <span>Dark Anisocoria (|R-L|):</span> <span id="rpt-sum-dark">-</span>
            </div>
            <div class="sum-row" style="font-size:1.1em; margin-bottom:8px;">
                <span>Light Anisocoria (|R-L|):</span> <span id="rpt-sum-light">-</span>
            </div>
            <div class="sum-row" style="border-top:1px solid #ccc; padding-top:10px; font-size:1.4em; font-weight:800; color:#d32f2f;">
                <span>Difference (Dark - Light):</span> <span id="rpt-sum-final">-</span>
            </div>
            <p style="font-size:12px; color:#777; margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                <strong>Disclaimer:</strong> This report is computer-generated for educational reference only. It does not constitute a medical diagnosis. 
                * Positive value indicates greater anisocoria in the dark. Negative value suggests parasympathetic defect.
            </p>
        </div>
    </div>
</div>

<!-- STATS MODAL -->
<div class="modal-overlay" id="statsModal">
    <div class="modal-content stats-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:#333;">Usage Statistics</h2>
            <button class="tool-btn" onclick="document.getElementById('statsModal').style.display='none'">Close</button>
        </div>
        <canvas id="statsChart" width="400" height="250"></canvas>
        <p style="font-size:11px; color:#999; margin-top:15px; text-align:center;">
            Data source: Local Session & Mock History. Connect a backend API for global tracking.
        </p>
    </div>
</div>

<script>
    // === APP STATE ===
    const STATE = {
        light: { img: null, lines: {}, filters: {b:100, c:100} },
        dark:  { img: null, lines: {}, filters: {b:100, c:100} }
    };
    let activeTab = 'light';
    let activeTool = null;
    let cam = { x: 0, y: 0, zoom: 1 };
    let mouse = { x:0, y:0, down:false, drawing:false, dragStart:{x:0,y:0}, drawStart:{x:0,y:0} };

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvasContainer');

    // === INIT ===
    function init() {
        window.addEventListener('resize', resize);
        resize();
        render();
        initStats(); // Initialize counter
    }
    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        render();
    }

    // === TABS & UI ===
    window.switchTab = function(mode) {
        activeTab = mode;
        activeTool = null;
        
        // Update UI Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');
        
        // Update Image Status
        const data = STATE[activeTab];
        document.getElementById('img-status').style.display = data.img ? 'inline' : 'none';
        
        // Restore Filters
        document.getElementById('slider-br').value = data.filters.b;
        document.getElementById('slider-ct').value = data.filters.c;
        updateSliderLabels();

        // Fit Camera
        if(data.img) fitCam();
        
        // Reset Tools
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        
        recalcAll();
        render();
    }

    // === IMAGE HANDLING ===
    document.getElementById('fileInput').addEventListener('change', e => loadImg(e.target.files[0]));
    document.addEventListener('paste', e => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for(let item of items) if(item.type.startsWith('image')) loadImg(item.getAsFile());
    });

    function loadImg(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                STATE[activeTab].img = img;
                STATE[activeTab].lines = {}; // Reset measurements
                // Reset Filters for new image
                STATE[activeTab].filters = {b:100, c:100};
                document.getElementById('slider-br').value = 100;
                document.getElementById('slider-ct').value = 100;
                updateSliderLabels();
                
                document.getElementById('img-status').style.display = 'inline';
                fitCam();
                recalcAll();
                render();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function fitCam() {
        const img = STATE[activeTab].img;
        if(img) {
            cam.zoom = Math.min((canvas.width*0.9)/img.width, (canvas.height*0.9)/img.height);
            cam.x = (canvas.width - img.width * cam.zoom)/2;
            cam.y = (canvas.height - img.height * cam.zoom)/2;
        }
    }

    // === FILTERS ===
    window.updateFilters = function() {
        const b = document.getElementById('slider-br').value;
        const c = document.getElementById('slider-ct').value;
        STATE[activeTab].filters = { b: parseInt(b), c: parseInt(c) };
        updateSliderLabels();
        render();
    }
    window.resetFilters = function() {
        document.getElementById('slider-br').value = 100;
        document.getElementById('slider-ct').value = 100;
        updateFilters();
    }
    function updateSliderLabels() {
        document.getElementById('val-br').innerText = STATE[activeTab].filters.b;
        document.getElementById('val-ct').innerText = STATE[activeTab].filters.c;
    }

    // === CANVAS ===
    const toWorld = (sx, sy) => ({ x: (sx - cam.x)/cam.zoom, y: (sy - cam.y)/cam.zoom });
    const dist = (p1, p2) => Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));

    window.setTool = function(tool) {
        if(!STATE[activeTab].img) { alert("Please upload an image first."); return; }
        activeTool = tool;
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tool.replace('_','-')).classList.add('active');
    }

    canvas.addEventListener('mousedown', e => {
        if(e.button === 2 || e.shiftKey) { // Pan
            mouse.down = true; mouse.drawing = false;
            mouse.dragStart = { x: e.offsetX - cam.x, y: e.offsetY - cam.y };
        } else if(e.button === 0 && activeTool) { // Draw
            mouse.down = true; mouse.drawing = true;
            mouse.drawStart = toWorld(e.offsetX, e.offsetY);
            mouse.curr = mouse.drawStart;
        }
    });
    canvas.addEventListener('mousemove', e => {
        if(mouse.down && !mouse.drawing) {
            cam.x = e.offsetX - mouse.dragStart.x;
            cam.y = e.offsetY - mouse.dragStart.y;
            render();
        } else if(mouse.down && mouse.drawing) {
            mouse.curr = toWorld(e.offsetX, e.offsetY);
            render();
        }
    });
    canvas.addEventListener('mouseup', () => {
        if(mouse.drawing && dist(mouse.drawStart, mouse.curr) > 0) {
            STATE[activeTab].lines[activeTool] = { p1: mouse.drawStart, p2: mouse.curr };
            recalcAll();
        }
        mouse.down = false; mouse.drawing = false;
        render();
    });
    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        const d = e.deltaY > 0 ? 0.9 : 1.1;
        const wx = (e.offsetX - cam.x) / cam.zoom;
        const wy = (e.offsetY - cam.y) / cam.zoom;
        cam.zoom *= d;
        cam.x = e.offsetX - wx * cam.zoom;
        cam.y = e.offsetY - wy * cam.zoom;
        render();
    });
    canvas.addEventListener('contextmenu', e => e.preventDefault());

    // === RENDER ===
    function render() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        const data = STATE[activeTab];
        
        ctx.save();
        ctx.translate(cam.x, cam.y);
        ctx.scale(cam.zoom, cam.zoom);

        if(data.img) {
            // Apply Filters ONLY to image
            ctx.save();
            ctx.filter = `brightness(${data.filters.b}%) contrast(${data.filters.c}%)`;
            ctx.drawImage(data.img, 0, 0);
            ctx.restore();
        } else {
            ctx.fillStyle = "#ccc"; ctx.font = "20px sans-serif"; ctx.textAlign="center";
            ctx.fillText("Please Upload / Paste Image", canvas.width/2/cam.zoom, canvas.height/2/cam.zoom);
        }

        // Lines (unfiltered)
        ctx.lineWidth = 2 / cam.zoom;
        Object.entries(data.lines).forEach(([k, l]) => { if(l) drawLine(l, k.includes('pupil')?'#e74c3c':'#28a745'); });
        if(mouse.drawing) drawLine({p1:mouse.drawStart, p2:mouse.curr}, 'yellow');

        ctx.restore();
    }

    function drawLine(l, c) {
        ctx.beginPath(); ctx.moveTo(l.p1.x, l.p1.y); ctx.lineTo(l.p2.x, l.p2.y);
        ctx.strokeStyle = c; ctx.stroke();
        ctx.fillStyle = c; const r = 3/cam.zoom;
        ctx.beginPath(); ctx.arc(l.p1.x, l.p1.y, r, 0, 6.28); ctx.fill();
        ctx.beginPath(); ctx.arc(l.p2.x, l.p2.y, r, 0, 6.28); ctx.fill();
    }

    // === CALC ===
    function calcMm(data, refMm) {
        const l = data.lines;
        let rc = l.r_cornea ? dist(l.r_cornea.p1, l.r_cornea.p2) : 0;
        let rp = l.r_pupil ? dist(l.r_pupil.p1, l.r_pupil.p2) : 0;
        let lc = l.l_cornea ? dist(l.l_cornea.p1, l.l_cornea.p2) : 0;
        let lp = l.l_pupil ? dist(l.l_pupil.p1, l.l_pupil.p2) : 0;

        let r = (rc > 0 && rp > 0) ? (rp/rc)*refMm : 0;
        let l_res = (lc > 0 && lp > 0) ? (lp/lc)*refMm : 0;
        let diff = (r>0 && l_res>0) ? Math.abs(r-l_res) : null;
        return { r, l:l_res, diff };
    }

    window.recalcAll = function() {
        const ref = parseFloat(document.getElementById('refCornea').value) || 12;
        const local = calcMm(STATE[activeTab], ref);
        const light = calcMm(STATE.light, ref);
        const dark = calcMm(STATE.dark, ref);

        const fmt = n => n>0 ? n.toFixed(2)+' mm' : '-';
        
        // Local Panel
        document.getElementById('loc-r').innerText = fmt(local.r);
        document.getElementById('loc-l').innerText = fmt(local.l);
        document.getElementById('loc-diff').innerText = local.diff!==null ? local.diff.toFixed(2)+' mm' : '-';

        // Global Panel
        const d_diff = dark.diff;
        const l_diff = light.diff;
        document.getElementById('glb-dark').innerText = d_diff!==null ? d_diff.toFixed(2)+' mm' : '-';
        document.getElementById('glb-light').innerText = l_diff!==null ? l_diff.toFixed(2)+' mm' : '-';
        
        if(d_diff!==null && l_diff!==null) {
            const final = d_diff - l_diff;
            const sign = final > 0 ? "+" : "";
            document.getElementById('glb-final').innerText = sign + final.toFixed(2) + ' mm';
        } else {
            document.getElementById('glb-final').innerText = '-';
        }
    }

    // === REPORT ===
    window.openReport = function() {
        const ref = parseFloat(document.getElementById('refCornea').value) || 12;
        document.getElementById('rpt-date').innerText = new Date().toLocaleDateString();
        document.getElementById('rpt-ref').innerText = ref;

        fillRptData('light', ref);
        fillRptData('dark', ref);

        const l = calcMm(STATE.light, ref);
        const d = calcMm(STATE.dark, ref);
        
        const fmt = n => n!==null ? n.toFixed(2)+' mm' : '-';
        document.getElementById('rpt-sum-dark').innerText = fmt(d.diff);
        document.getElementById('rpt-sum-light').innerText = fmt(l.diff);
        
        if(d.diff!==null && l.diff!==null) {
            const final = d.diff - l.diff;
            const sign = final > 0 ? "+" : "";
            document.getElementById('rpt-sum-final').innerText = sign + final.toFixed(2) + ' mm';
        } else {
            document.getElementById('rpt-sum-final').innerText = '-';
        }

        document.getElementById('reportModal').style.display = 'flex';
    }

    function fillRptData(key, ref) {
        const data = STATE[key];
        const res = calcMm(data, ref);
        
        const fmt = n => n>0 ? n.toFixed(2)+' mm' : '-';
        document.getElementById(`rpt-${key.charAt(0)}-r`).innerText = fmt(res.r);
        document.getElementById(`rpt-${key.charAt(0)}-l`).innerText = fmt(res.l);
        document.getElementById(`rpt-${key.charAt(0)}-diff`).innerText = res.diff!==null ? res.diff.toFixed(2)+' mm' : '-';

        const imgEl = document.getElementById(`rpt-img-${key}`);
        if(data.img) {
            const tC = document.createElement('canvas');
            tC.width = data.img.width; tC.height = data.img.height;
            const tCtx = tC.getContext('2d');
            
            // Apply Burn-in Filters
            tCtx.filter = `brightness(${data.filters.b}%) contrast(${data.filters.c}%)`;
            tCtx.drawImage(data.img, 0, 0);
            tCtx.filter = 'none';

            // Draw Lines
            tCtx.lineWidth = Math.max(3, data.img.width/400);
            Object.entries(data.lines).forEach(([k,l])=>{
                if(l) {
                    const c = k.includes('pupil')?'#e74c3c':'#28a745';
                    tCtx.beginPath(); tCtx.moveTo(l.p1.x, l.p1.y); tCtx.lineTo(l.p2.x, l.p2.y);
                    tCtx.strokeStyle=c; tCtx.stroke();
                    tCtx.fillStyle=c;
                    tCtx.beginPath(); tCtx.arc(l.p1.x,l.p1.y,tCtx.lineWidth*2,0,6.28); tCtx.fill();
                    tCtx.beginPath(); tCtx.arc(l.p2.x,l.p2.y,tCtx.lineWidth*2,0,6.28); tCtx.fill();
                }
            });
            imgEl.src = tC.toDataURL('image/jpeg', 0.85);
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
    }

    // === STATS & COUNTER (Simulated for Single File) ===
    let chartInstance = null;
    let visitCount = 0;

    function initStats() {
        // Since we don't have a backend DB, we simulate persistence via localStorage
        let saved = localStorage.getItem('pupil_visits');
        visitCount = saved ? parseInt(saved) + 1 : 1204; // Start at arbitrary number for demo
        localStorage.setItem('pupil_visits', visitCount);
        document.getElementById('lbl-visits').innerText = visitCount.toLocaleString();
    }

    window.openStats = function() {
        document.getElementById('statsModal').style.display = 'flex';
        renderChart();
    }

    function renderChart() {
        if(chartInstance) chartInstance.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        
        // Generate last 7 days labels
        const labels = [];
        const dataPoints = [];
        for(let i=6; i>=0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('en-US', {month:'short', day:'numeric'}));
            // Mock data with some randomness around the current visit count baseline
            dataPoints.push(Math.floor(visitCount / 10 + Math.random() * 50));
        }
        
        // Make today match the high point
        dataPoints[6] = Math.floor(visitCount / 10 + 60);

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Daily Analysis Sessions',
                    data: dataPoints,
                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: {display:true, text:'Sessions'} },
                    x: { title: {display:true, text:'Date'} }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Activity Overview (Last 7 Days)' }
                }
            }
        });
    }

    init();
</script>
</body>
</html>