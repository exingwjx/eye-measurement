<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Bee 2026 - Go Eric</title>
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Themes --- */
        :root {
            /* Light Theme (Default) */
            --bg-color: #f4f7f6;
            --container-bg: #ffffff;
            --text-main: #333333;
            --text-muted: #666666;
            --border-color: #dddddd;
            --input-bg: #ffffff;
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e67e22;
            --success: #27ae60;
            --danger: #c0392b;
            --highlight: #f1c40f; /* Gold for flag */
            --item-hover: #f0f0f0;
            --font-size-base: 16px;
        }

        [data-theme="dark"] {
            /* Gemini-style Dark Theme */
            --bg-color: #131314;
            --container-bg: #1e1f20;
            --text-main: #e3e3e3;
            --text-muted: #a0a0a0;
            --border-color: #444746;
            --input-bg: #2d2e2f;
            --primary: #a8c7fa; 
            --secondary: #8ab4f8;
            --accent: #faa76c;
            --success: #81c995;
            --danger: #f28b82;
            --highlight: #fdd663;
            --item-hover: #303134;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            padding: 20px; 
            font-size: var(--font-size-base);
            transition: background 0.3s, color 0.3s;
        }

        .container { 
            max-width: 950px; 
            margin: 0 auto; 
            background: var(--container-bg); 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        
        h1, h2, h3 { color: var(--primary); text-align: center; margin-top: 0; }
        
        /* Buttons */
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 5px; font-size: 0.9em; }
        .btn-primary { background: var(--secondary); color: var(--bg-color); } 
        .btn-success { background: var(--success); color: #000; }
        .btn-danger { background: var(--danger); color: #000; }
        .btn-dark { background: var(--text-main); color: var(--bg-color); }
        .btn-outline { background: transparent; border: 2px solid var(--secondary); color: var(--secondary); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Sections */
        .section { display: none; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Settings Bar */
        .settings-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); font-size: 0.9em; flex-wrap: wrap; gap: 10px; }
        .theme-controls button, .font-controls button { padding: 5px 10px; font-size: 0.8em; }

        /* Setup Grid */
        .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .checkbox-label { display: flex; align-items: center; gap: 8px; padding: 10px; background: var(--item-hover); border: 1px solid var(--border-color); border-radius: 5px; cursor: pointer; font-size: 0.95em; color: var(--text-main); }
        .stat-badge { font-size: 0.8em; color: var(--text-muted); margin-left: auto; font-family: monospace; }
        
        /* Inputs */
        .config-row { display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap; }
        select, input { padding: 10px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main); border-radius: 5px; font-size: 1em; }

        /* Quiz Interface */
        .quiz-card { text-align: center; padding: 20px; border-bottom: 2px solid var(--border-color); }
        .question-text { font-size: 1.4em; margin-bottom: 20px; font-weight: 500; color: var(--text-main); }
        .input-area { margin: 20px 0; }
        input[type="text"] { padding: 15px; font-size: 1.2em; width: 80%; outline: none; }
        input[type="text"]:focus { border-color: var(--secondary); }
        
        .feedback { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; }
        .feedback.correct { background: rgba(39, 174, 96, 0.2); color: var(--success); border: 1px solid var(--success); }
        .feedback.incorrect { background: rgba(192, 57, 43, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        
        /* Controls */
        .controls { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
        .mark-btn { font-size: 1.8em; cursor: pointer; color: var(--border-color); user-select: none; transition: color 0.2s; }
        .mark-btn.marked { color: var(--highlight); text-shadow: 0 0 5px rgba(241, 196, 15, 0.5); }

        /* Results Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 10px; border: 1px solid var(--border-color); text-align: left; color: var(--text-main); }
        th { background: var(--item-hover); color: var(--primary); }
        .row-correct { background-color: rgba(39, 174, 96, 0.1); }
        .row-wrong { background-color: rgba(192, 57, 43, 0.1); }

        /* Progress Chart */
        .chart-container { position: relative; height: 450px; width: 100%; margin-top: 20px; }
        .history-list { margin-top: 30px; max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); }

        /* Admin */
        .admin-login { max-width: 400px; margin: 20px auto; text-align: center; }
        .admin-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .admin-box { background: var(--item-hover); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        textarea { width: 100%; height: 80px; margin-top: 5px; background: var(--input-bg); color: var(--text-main); border: 1px solid var(--border-color); }

        .footer-note { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 0.8em; color: var(--text-muted); text-align: center; }

        /* Print */
        @media print {
            body { background: white; color: black; }
            .container { box-shadow: none; width: 100%; max-width: 100%; margin: 0; padding: 0; border: none; }
            .no-print { display: none !important; }
            .section { display: block !important; }
            #setup, #quiz, #admin, #progress { display: none !important; }
            #results { display: block !important; }
            .feedback { border: 1px solid #ccc; color: #000; }
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Top Settings Bar -->
    <div class="settings-bar no-print">
        <div class="theme-controls">
            <span>Theme: </span>
            <button class="btn btn-outline" onclick="setTheme('light')">â˜€ Light</button>
            <button class="btn btn-outline" onclick="setTheme('dark')">ðŸŒ™ Dark</button>
        </div>
        <div class="font-controls">
            <span>Font Size: </span>
            <button class="btn btn-outline" onclick="adjustFont(-2)">A-</button>
            <button class="btn btn-outline" onclick="resetFont()">Default</button>
            <button class="btn btn-outline" onclick="adjustFont(2)">A+</button>
        </div>
    </div>

    <!-- Header -->
    <header>
        <h1>ðŸ§  Brain Bee 2026 - Go Eric</h1>
        <div style="text-align: right;" class="no-print">
            <button class="btn btn-outline" onclick="showSection('setup')">Home</button>
            <button class="btn btn-outline" onclick="showProgressSection()">View My Progress</button>
            <button class="btn btn-outline" onclick="showAdmin()">Admin</button>
        </div>
    </header>

    <!-- 1. Setup Section -->
    <div id="setup" class="section active">
        <h2>Configure Self-Test</h2>
        
        <h3>1. Select Chapters</h3>
        <p style="text-align:center; font-size:0.9em; color:var(--text-muted);">Format: <strong>Total Qs / Answered Qs (Accuracy %)</strong></p>
        <div style="margin-bottom: 10px; text-align:center;">
            <button class="btn btn-sm btn-outline" onclick="toggleAllChapters(true)">Select All</button>
            <button class="btn btn-sm btn-outline" onclick="toggleAllChapters(false)">Deselect All</button>
        </div>
        <div id="chapter-list" class="options-grid"></div>

        <h3>2. Question Source</h3>
        <div class="options-grid">
            <label class="checkbox-label"><input type="checkbox" id="source-new" checked> New Questions</label>
            <label class="checkbox-label"><input type="checkbox" id="source-wrong" checked> Previously Wrong</label>
            <label class="checkbox-label"><input type="checkbox" id="source-marked"> Flagged Questions</label>
            <label class="checkbox-label"><input type="checkbox" id="source-used"> All Used Questions</label>
        </div>

        <h3>3. Number of Questions</h3>
        <div class="config-row">
            <select id="question-count-select" onchange="toggleCustomInput()">
                <option value="10">10 Questions</option>
                <option value="25">25 Questions</option>
                <option value="50">50 Questions</option>
                <option value="100">100 Questions</option>
                <option value="all">All Matching</option>
                <option value="custom">Custom Number...</option>
            </select>
            <input type="number" id="question-count-custom" placeholder="Enter number" style="display:none; width: 100px;" min="1">
        </div>
        
        <br>
        <center>
            <button class="btn btn-success" style="font-size: 1.2em; padding: 15px 40px;" onclick="startTest()">Start Test</button>
        </center>
    </div>

    <!-- 2. Quiz Section -->
    <div id="quiz" class="section">
        <div class="controls">
            <span id="progress-text">Question 1 of 10</span>
            <!-- FLAG ICON -->
            <span class="mark-btn" id="mark-indicator" onclick="toggleMark()" title="Flag for review">âš‘</span>
        </div>
        <div class="quiz-card">
            <div id="question-display" class="question-text">Loading...</div>
            
            <div class="input-area">
                <input type="text" id="user-answer" placeholder="Type answer here..." 
                       onpaste="return false" ondrop="return false" autocomplete="off">
            </div>

            <button id="submit-btn" class="btn btn-primary" onclick="submitAnswer()">Submit Answer</button>
            <div id="feedback-display" class="feedback"></div>
        </div>

        <div class="controls">
            <button id="prev-btn" class="btn btn-outline" onclick="navQuestion(-1)">Previous</button>
            <button id="next-btn" class="btn btn-outline" onclick="navQuestion(1)">Next</button>
            <button class="btn btn-danger" onclick="finishTest()">Finish Test</button>
        </div>
    </div>

    <!-- 3. Results Section -->
    <div id="results" class="section">
        <h2>Test Results</h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 id="score-display">Score: 0%</h3>
            <p id="date-display"></p>
        </div>
        <div class="no-print" style="text-align: center; margin-bottom: 20px;">
            <button class="btn btn-primary" onclick="window.print()">Print / Save PDF</button>
            <button class="btn btn-success" onclick="emailReport()">ðŸ“§ Email to Mom/Dad</button>
            <button class="btn btn-outline" onclick="showSection('setup')">Take New Test</button>
        </div>
        <table id="results-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Question</th>
                    <th>Your Answer</th>
                    <th>Correct Answer</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 4. Progress Section -->
    <div id="progress" class="section">
        <h2>My Progress</h2>
        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
        
        <div style="margin-top: 30px;">
            <h3>History Log</h3>
            <p style="text-align:center;">This allows you to check your report history.</p>
            <div style="text-align: center; margin-bottom: 10px;">
                <button class="btn btn-dark" onclick="downloadHistoryCSV()">Download History Record (CSV)</button>
            </div>
            <div class="history-list">
                <table id="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Score</th>
                            <th>Correct / Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. Admin Section -->
    <div id="admin" class="section">
        <h2>Admin Panel</h2>
        <div id="admin-login" class="admin-login">
            <input type="password" id="admin-pass" placeholder="Enter Password" style="padding: 10px; width: 200px;">
            <button class="btn btn-primary" onclick="verifyAdmin()">Login</button>
        </div>
        
        <div id="admin-content" style="display: none;">
            <div style="display:flex; justify-content:space-between; align-items:center; background:var(--item-hover); padding:10px; border-radius:5px;">
                <span>Total Questions in DB: <strong id="db-total">0</strong></span>
                <button class="btn btn-danger btn-sm" onclick="resetProgress()">Reset All Stats</button>
            </div>
            
            <div class="admin-panel-grid">
                <!-- Templates -->
                <div class="admin-box">
                    <h3>1. Templates & Export</h3>
                    <button class="btn btn-dark" onclick="downloadJSONTemplate()">JSON Template</button>
                    <button class="btn btn-dark" onclick="downloadExcelTemplate()">Excel Template</button>
                    <hr>
                    <button class="btn btn-success" onclick="exportDatabaseToExcel()">Download Full DB (Excel)</button>
                </div>

                <!-- Import -->
                <div class="admin-box">
                    <h3>2. Bulk Import</h3>
                    <p style="font-size:0.8em; color:var(--text-muted);">Note: Duplicates (Same Text + Category) will be skipped.</p>
                    
                    <h4>Option A: Excel Upload</h4>
                    <input type="file" id="excel-upload" accept=".xlsx, .xls" style="margin-bottom:10px;">
                    <button class="btn btn-primary" onclick="importFromExcel()">Import Excel</button>

                    <h4>Option B: Paste JSON</h4>
                    <textarea id="bulk-import" placeholder='[{"id":"01","q":"...","a":"...","category":"..."}]'></textarea>
                    <button class="btn btn-secondary" onclick="runBulkImport()">Import JSON</button>
                </div>

                <!-- Password Settings -->
                <div class="admin-box">
                    <h3>3. Security Settings</h3>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <input type="password" id="pass-old" placeholder="Old Password" style="padding: 8px;">
                        <input type="password" id="pass-new" placeholder="New Password" style="padding: 8px;">
                        <input type="password" id="pass-confirm" placeholder="Confirm New Password" style="padding: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="changeAdminPass()">Update Password</button>
                    </div>
                    <hr>
                    <button class="btn btn-outline btn-sm" onclick="resetAdminPass()">Reset to Default</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-note no-print">
        <p><strong>Statistics Legend:</strong> "90 / 60 (32%)" means: Total 90 questions in this chapter | 60 unique questions have been attempted at least once | 32% Global Accuracy (Total Correct Answers / Total Attempts).</p>
    </div>

</div>

<script>
    // --- Data Management ---
    const DB_KEY = 'brainbee_eric_master_db';
    const HIST_KEY = 'brainbee_eric_master_hist';
    const PASS_KEY = 'brainbee_admin_pass';
    const PREF_KEY = 'brainbee_eric_pref';
    const DEFAULT_PASS = "BEE";
    
    // Initial Starter Data
    const initialQuestions = [
        { id: "A001", category: "Anatomy & Basic Structure", q: "The largest part of the human brain is the ______.", a: "Cerebrum" },
        { id: "A002", category: "Anatomy & Basic Structure", q: "The large bundle of nerve fibers connecting the left and right cerebral hemispheres is the ______.", a: "Corpus Callosum" }
    ];

    let db = []; 
    let history = [];
    let preferences = { theme: 'light', fontSize: 16 };
    let currentTest = [];
    let testIndex = 0;
    let userResponses = {};
    let chartInstance = null;

    window.onload = function() {
        loadData();
        applyPreferences();
        renderChapters();
    };

    function loadData() {
        const storedDB = localStorage.getItem(DB_KEY);
        if (storedDB) {
            db = JSON.parse(storedDB);
        } else {
            db = initialQuestions.map(q => ({
                ...q,
                stats: { correct: 0, total: 0 },
                marked: false
            }));
            saveData();
        }

        const storedHist = localStorage.getItem(HIST_KEY);
        if (storedHist) history = JSON.parse(storedHist);

        const storedPref = localStorage.getItem(PREF_KEY);
        if (storedPref) preferences = JSON.parse(storedPref);
    }

    function saveData() {
        localStorage.setItem(DB_KEY, JSON.stringify(db));
        localStorage.setItem(HIST_KEY, JSON.stringify(history));
    }

    function savePreferences() {
        localStorage.setItem(PREF_KEY, JSON.stringify(preferences));
    }

    // --- Appearance Logic ---
    function setTheme(theme) {
        preferences.theme = theme;
        applyPreferences();
    }

    function adjustFont(delta) {
        preferences.fontSize += delta;
        if(preferences.fontSize < 12) preferences.fontSize = 12;
        if(preferences.fontSize > 24) preferences.fontSize = 24;
        applyPreferences();
    }

    function resetFont() {
        preferences.fontSize = 16;
        applyPreferences();
    }

    function applyPreferences() {
        document.documentElement.setAttribute('data-theme', preferences.theme);
        document.documentElement.style.setProperty('--font-size-base', preferences.fontSize + 'px');
        savePreferences();
        
        // Re-render chart if visible because Chart.js needs to update colors based on theme
        if(document.getElementById('progress').classList.contains('active')) {
            renderChart();
        }
    }

    // --- Setup UI & Stats ---
    function renderChapters() {
        const categories = [...new Set(db.map(q => q.category))].sort();
        const container = document.getElementById('chapter-list');
        container.innerHTML = '';
        
        if(categories.length === 0) container.innerHTML = "No questions found. Please import via Admin.";

        categories.forEach(cat => {
            const catQs = db.filter(q => q.category === cat);
            const total = catQs.length;
            const uniqueAnswered = catQs.filter(q => q.stats.total > 0).length;
            const sumCorrect = catQs.reduce((sum, q) => sum + q.stats.correct, 0);
            const sumAttempts = catQs.reduce((sum, q) => sum + q.stats.total, 0);
            const accuracy = sumAttempts === 0 ? 0 : Math.round((sumCorrect / sumAttempts) * 100);

            container.innerHTML += `
                <label class="checkbox-label">
                    <input type="checkbox" name="chapter" value="${cat}" checked> 
                    <span>${cat}</span>
                    <span class="stat-badge">${total} / ${uniqueAnswered} (${accuracy}%)</span>
                </label>`;
        });
    }

    function toggleAllChapters(select) {
        document.getElementsByName('chapter').forEach(cb => cb.checked = select);
    }

    function showSection(id) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function toggleCustomInput() {
        const sel = document.getElementById('question-count-select');
        const cust = document.getElementById('question-count-custom');
        cust.style.display = sel.value === 'custom' ? 'inline-block' : 'none';
    }

    // --- Test Logic ---
    function startTest() {
        const selectedChapters = Array.from(document.querySelectorAll('input[name="chapter"]:checked')).map(cb => cb.value);
        const useNew = document.getElementById('source-new').checked;
        const useWrong = document.getElementById('source-wrong').checked;
        const useMarked = document.getElementById('source-marked').checked;
        const useUsed = document.getElementById('source-used').checked;

        if (selectedChapters.length === 0) { alert("Select at least one chapter."); return; }
        if (!useNew && !useWrong && !useMarked && !useUsed) { alert("Select a question source."); return; }

        let pool = db.map((q, index) => ({...q, index})).filter(q => {
            if (!selectedChapters.includes(q.category)) return false;
            let isNew = q.stats.total === 0;
            let isWrong = q.stats.total > 0 && (q.stats.correct / q.stats.total) < 1;
            let isMarked = q.marked;
            let isUsed = q.stats.total > 0;

            if (useNew && isNew) return true;
            if (useWrong && isWrong) return true;
            if (useMarked && isMarked) return true;
            if (useUsed && isUsed) return true;
            return false;
        });

        if (pool.length === 0) { alert("No questions match criteria."); return; }

        pool.sort(() => Math.random() - 0.5);

        const selVal = document.getElementById('question-count-select').value;
        let limit = pool.length;
        
        if (selVal === 'custom') {
            const custVal = parseInt(document.getElementById('question-count-custom').value);
            if (custVal && custVal > 0) limit = custVal;
        } else if (selVal !== 'all') {
            limit = parseInt(selVal);
        }

        currentTest = pool.slice(0, limit).map(q => q.index);
        testIndex = 0;
        userResponses = {};
        showSection('quiz');
        renderQuestion();
    }

    function renderQuestion() {
        const qIdx = currentTest[testIndex];
        const q = db[qIdx];
        
        document.getElementById('progress-text').innerText = `Question ${testIndex + 1} of ${currentTest.length} (${q.category})`;
        document.getElementById('question-display').innerText = q.q;
        
        const input = document.getElementById('user-answer');
        input.value = "";
        input.disabled = false;
        input.focus();
        
        const markBtn = document.getElementById('mark-indicator');
        markBtn.className = q.marked ? "mark-btn marked" : "mark-btn";
        
        document.getElementById('feedback-display').style.display = 'none';
        document.getElementById('submit-btn').style.display = 'inline-block';
        
        if (userResponses[q.id]) {
            input.value = userResponses[q.id].userAnswer;
            input.disabled = true;
            document.getElementById('submit-btn').style.display = 'none';
            showFeedback(qIdx, userResponses[q.id].userAnswer);
        }

        document.getElementById('prev-btn').disabled = (testIndex === 0);
        document.getElementById('next-btn').disabled = (testIndex === currentTest.length - 1);
    }

    function toggleMark() {
        const qIdx = currentTest[testIndex];
        db[qIdx].marked = !db[qIdx].marked;
        renderQuestion();
        saveData();
    }

    function submitAnswer() {
        const input = document.getElementById('user-answer');
        const ans = input.value.trim();
        if (!ans) return;

        const qIdx = currentTest[testIndex];
        const cleanUser = ans.toLowerCase().replace(/[^a-z0-9]/g, "");
        const possibilities = db[qIdx].a.split(/;|\//).map(s => s.trim().toLowerCase().replace(/[^a-z0-9]/g, ""));
        const isCorrect = possibilities.some(p => cleanUser === p);

        userResponses[db[qIdx].id] = { userAnswer: ans, isCorrect: isCorrect };

        db[qIdx].stats.total++;
        if (isCorrect) db[qIdx].stats.correct++;
        saveData();

        input.disabled = true;
        document.getElementById('submit-btn').style.display = 'none';
        showFeedback(qIdx, ans);
    }

    function showFeedback(qIdx, userAns) {
        const q = db[qIdx];
        const isCorrect = userResponses[q.id].isCorrect;
        const fb = document.getElementById('feedback-display');
        
        if (isCorrect) {
            fb.className = "feedback correct";
            fb.innerHTML = `<strong>Correct!</strong>`;
        } else {
            fb.className = "feedback incorrect";
            fb.innerHTML = `<strong>Incorrect.</strong><br>Your Answer: ${userAns}<br>Correct Answer: <strong>${q.a}</strong>`;
        }
        fb.style.display = 'block';
    }

    function navQuestion(dir) {
        testIndex += dir;
        renderQuestion();
    }

    function finishTest() {
        showSection('results');
        const tbody = document.querySelector('#results-table tbody');
        tbody.innerHTML = '';
        
        let correctCount = 0;
        let answeredCount = 0;

        currentTest.forEach(idx => {
            const q = db[idx];
            const resp = userResponses[q.id];
            const tr = document.createElement('tr');
            
            if (resp) {
                answeredCount++;
                if (resp.isCorrect) correctCount++;
                tr.className = resp.isCorrect ? 'row-correct' : 'row-wrong';
                tr.innerHTML = `<td>${q.id}</td><td>${q.q}</td><td>${resp.userAnswer}</td><td>${q.a}</td><td>${resp.isCorrect ? 'âœ”' : 'âœ˜'}</td>`;
            } else {
                tr.innerHTML = `<td>${q.id}</td><td>${q.q}</td><td>-</td><td>${q.a}</td><td>Unanswered</td>`;
            }
            tbody.appendChild(tr);
        });

        const score = answeredCount > 0 ? Math.round((correctCount / answeredCount) * 100) : 0;
        document.getElementById('score-display').innerText = `Score: ${score}% (${correctCount}/${answeredCount})`;
        document.getElementById('date-display').innerText = new Date().toLocaleString();

        if (answeredCount > 0) {
            history.push({
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString(),
                timestamp: Date.now(),
                score: score,
                total: answeredCount,
                correct: correctCount
            });
            saveData();
        }
        renderChapters();
    }

    // --- Email Function ---
    function emailReport() {
        const scoreText = document.getElementById('score-display').innerText;
        const dateText = document.getElementById('date-display').innerText;
        
        let body = `Hi,\n\nHere is Eric's Brain Bee Practice Report.\n\nDate: ${dateText}\n${scoreText}\n\n`;
        body += "Great job! Keep practicing.\n\n(Sent from Brain Bee App)";
        
        const link = `mailto:exingwjx@gmail.com?subject=Brain Bee Report - ${dateText}&body=${encodeURIComponent(body)}`;
        window.location.href = link;
    }

    // --- Chart & History Logic ---
    function showProgressSection() {
        showSection('progress');
        // Delay slightly to allow display:block to take effect before chart renders
        setTimeout(() => {
            renderChart();
            renderHistoryTable();
        }, 50);
    }

    function renderHistoryTable() {
        const tbody = document.querySelector('#history-table tbody');
        tbody.innerHTML = '';
        const sortedHistory = [...history].reverse();
        sortedHistory.forEach(h => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${h.date}</td>
                <td>${h.time || '-'}</td>
                <td><strong>${h.score}%</strong></td>
                <td>${h.correct} / ${h.total}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function downloadHistoryCSV() {
        if(history.length === 0) { alert("No history to download."); return; }
        
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Time,Score_Percent,Correct,Total_Questions\n";
        
        history.forEach(h => {
            csvContent += `${h.date},${h.time || ''},${h.score},${h.correct},${h.total}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "eric_brain_bee_history.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function renderChart() {
        const ctx = document.getElementById('progressChart').getContext('2d');
        
        // Define colors based on theme
        const isDark = preferences.theme === 'dark';
        const gridColor = isDark ? '#444746' : '#ddd';
        const textColor = isDark ? '#e3e3e3' : '#333';

        const dailyStats = {};
        history.forEach(h => {
            if (!dailyStats[h.date]) dailyStats[h.date] = { correct: 0, total: 0 };
            dailyStats[h.date].correct += h.correct;
            dailyStats[h.date].total += h.total;
        });

        const labels = Object.keys(dailyStats).sort();
        const percentData = labels.map(date => {
            const d = dailyStats[date];
            return d.total === 0 ? 0 : Math.round((d.correct / d.total) * 100);
        });
        const volumeData = labels.map(date => dailyStats[date].total);

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line',
                        label: 'Accuracy (%)',
                        data: percentData,
                        borderColor: '#3498db',
                        backgroundColor: '#3498db',
                        yAxisID: 'y',
                        tension: 0.3,
                        pointRadius: 5
                    },
                    {
                        type: 'bar',
                        label: 'Qs Answered',
                        data: volumeData,
                        backgroundColor: 'rgba(230, 126, 34, 0.5)', 
                        borderColor: '#e67e22',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        min: 0,
                        max: 100,
                        title: { display: true, text: 'Percentage Correct', color: textColor },
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false },
                        title: { display: true, text: 'Questions Answered', color: textColor },
                        ticks: { color: textColor }
                    }
                },
                plugins: {
                    legend: { labels: { color: textColor } }
                }
            }
        });
    }

    // --- Admin & Import ---
    function showAdmin() {
        showSection('admin');
        document.getElementById('admin-content').style.display = 'none';
        document.getElementById('admin-login').style.display = 'block';
        document.getElementById('admin-pass').value = '';
    }

    function getAdminPass() {
        return localStorage.getItem(PASS_KEY) || DEFAULT_PASS;
    }

    function verifyAdmin() {
        if (document.getElementById('admin-pass').value === getAdminPass()) {
            document.getElementById('admin-login').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            document.getElementById('db-total').innerText = db.length;
        } else {
            alert("Incorrect Password");
        }
    }

    function changeAdminPass() {
        const stored = getAdminPass();
        const oldP = document.getElementById('pass-old').value;
        const newP = document.getElementById('pass-new').value;
        const confP = document.getElementById('pass-confirm').value;

        if(oldP !== stored) { alert("Old password incorrect."); return; }
        if(newP.length === 0) { alert("New password cannot be empty."); return; }
        if(newP !== confP) { alert("New passwords do not match."); return; }

        localStorage.setItem(PASS_KEY, newP);
        alert("Password updated successfully.");
        // Clear inputs
        document.getElementById('pass-old').value = "";
        document.getElementById('pass-new').value = "";
        document.getElementById('pass-confirm').value = "";
    }

    function resetAdminPass() {
        const stored = getAdminPass();
        const input = prompt("Please enter current password to reset to default:");
        if(input === stored) {
            localStorage.removeItem(PASS_KEY);
            alert("Password reset to default 'BEE'.");
        } else {
            alert("Incorrect password.");
        }
    }

    function resetProgress() {
        if(confirm("This keeps questions but zeroes out all correctness stats and unmarks flags. Continue?")) {
            db.forEach(q => { q.stats = { correct: 0, total: 0 }; q.marked = false; });
            saveData();
            renderChapters();
            alert("Stats reset.");
        }
    }

    // --- Import Logic ---
    function downloadJSONTemplate() {
        const sample = [{ "id": "X1", "category": "Anatomy & Basic Structure", "q": "Sample Question?", "a": "Answer" }];
        const blob = new Blob([JSON.stringify(sample, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'brainbee_template.json';
        link.click();
    }

    function downloadExcelTemplate() {
        const wb = XLSX.utils.book_new();
        const ws_data = [["ID", "Category", "Question", "Answer"], ["D1", "Anatomy & Basic Structure", "Sample Q", "Sample A"]];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Template");
        XLSX.writeFile(wb, "brainbee_template.xlsx");
    }

    function exportDatabaseToExcel() {
        const exportData = db.map(item => ({
            ID: item.id,
            Category: item.category,
            Question: item.q,
            Answer: item.a,
            Attempts: item.stats.total,
            Correct: item.stats.correct,
            Marked: item.marked ? "Yes" : "No"
        }));
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, "QuestionBank");
        XLSX.writeFile(wb, `brainbee_full_db_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function importFromExcel() {
        const fileInput = document.getElementById('excel-upload');
        const file = fileInput.files[0];
        if (!file) { alert("Select file first."); return; }

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonRows = XLSX.utils.sheet_to_json(firstSheet);
            
            const newQuestions = jsonRows.map((row, idx) => ({
                id: row.ID || `IMP${Date.now()}${idx}`,
                category: row.Category || "Uncategorized",
                q: row.Question || "Empty Question",
                a: row.Answer || "Empty Answer"
            }));

            processImport(newQuestions);
        };
        reader.readAsArrayBuffer(file);
    }

    function runBulkImport() {
        try {
            const newQs = JSON.parse(document.getElementById('bulk-import').value);
            if (!Array.isArray(newQs)) throw new Error("Not array");
            processImport(newQs);
        } catch(e) { alert("Invalid JSON"); }
    }

    function processImport(newQuestions) {
        let addedCount = 0;
        let skippedCount = 0;

        newQuestions.forEach(nq => {
            const exists = db.find(existing => 
                existing.id === nq.id || 
                (existing.q.trim() === nq.q.trim() && existing.category === nq.category)
            );

            if (!exists) {
                db.push({
                    ...nq,
                    stats: { correct: 0, total: 0 },
                    marked: false
                });
                addedCount++;
            } else {
                skippedCount++;
            }
        });

        saveData();
        renderChapters(); 
        document.getElementById('db-total').innerText = db.length;
        alert(`Import Complete.\nAdded: ${addedCount}\nSkipped (Duplicates): ${skippedCount}`);
    }

</script>
</body>
</html>