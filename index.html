<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pupilometer Pro V14 - Independent Scales</title>
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base Styles --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; padding: 0; background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }
        * { box-sizing: border-box; }

        /* --- Top Bar --- */
        .top-bar {
            background: #fff; border-bottom: 1px solid #ccc; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center; height: 60px; z-index: 10;
        }
        .app-title { font-weight: 800; font-size: 1.2em; color: #2c3e50; letter-spacing: -0.5px; }
        
        .mode-tabs { display: flex; background: #e9ecef; padding: 4px; border-radius: 6px; }
        .tab-btn {
            border: none; background: transparent; padding: 6px 16px; font-weight: 600; color: #666; cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 0.9em;
        }
        .tab-btn.active { background: #fff; color: #007bff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        
        .gen-btn { background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.9em; display: flex; align-items: center; gap: 6px;}
        .gen-btn:hover { background: #218838; }

        /* Top Bar Inputs & Custom Scale */
        .top-inputs { display: flex; gap: 15px; align-items: center; margin-right: 15px; }
        .input-group { font-size: 0.9em; color: #555; display: flex; align-items: center; gap: 5px; }
        .input-box { width: 55px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }
        
        .scale-toggle-btn { background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em; display: flex; align-items: center; gap:5px; }
        .scale-toggle-btn.active { background: #ffc107; color: #333; }
        
        .scale-controls { display: none; gap: 8px; align-items: center; background: #fff3cd; padding: 4px 8px; border-radius: 4px; border: 1px solid #ffeeba; margin-left: 10px; font-size: 0.85em;}

        /* --- Layout --- */
        .main-container { display: flex; flex: 1; height: calc(100vh - 60px); }

        /* --- Sidebar --- */
        .sidebar {
            width: 340px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column;
            overflow-y: auto; padding: 15px; gap: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.05); z-index: 5;
        }

        /* Panels */
        .panel { border: 1px solid #eee; padding: 12px; border-radius: 8px; background: #fcfcfc; flex-shrink: 0; }
        .panel-label { font-size: 0.75em; font-weight: 700; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Summary Box */
        .summary-box { background: #e3f2fd; border: 1px solid #90caf9; }
        .sum-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 4px; color: #333; }
        .sum-final { border-top: 1px solid #90caf9; margin-top: 8px; padding-top: 8px; font-weight: 800; color: #d32f2f; font-size: 1.1em; }

        /* Standard Tools (Grid) */
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tool-wrapper { display: flex; flex-direction: column; }
        
        .tool-btn { 
            padding: 8px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: 500; text-align: center;
        }
        .tool-btn:hover { background: #f8f9fa; }
        .tool-btn.active { background: #007bff; color: white; border-color: #0056b3; }
        
        /* Result Text under button */
        .val-display { 
            text-align: center; font-size: 0.85em; color: #007bff; font-weight: bold; margin-top: 4px; min-height: 1.2em;
        }

        /* Extra Measurements */
        .extra-list { display: flex; flex-direction: column; gap: 8px; }
        .extra-item { display: flex; align-items: center; gap: 5px; background: #fff; border: 1px solid #eee; padding: 5px; border-radius: 4px; }
        .extra-name-input { border: none; border-bottom: 1px solid #ccc; width: 80px; font-size: 0.85em; padding: 2px; color: #333; background: transparent; }
        .extra-name-input:focus { outline: none; border-bottom-color: #007bff; }
        .extra-val { font-size: 0.85em; font-weight: bold; color: #17a2b8; margin-left: auto; margin-right: 5px; min-width: 40px; text-align: right;}
        
        .extra-btn-measure { font-size: 0.8em; padding: 3px 8px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; background: #f8f9fa; }
        .extra-btn-measure.active { background: #17a2b8; color: white; border-color: #138496; }
        .extra-btn-del { color: #dc3545; cursor: pointer; font-weight: bold; padding: 0 5px; font-size: 1.1em; }
        
        .add-btn { width: 100%; border: 1px dashed #999; color: #555; background: #f0f0f0; margin-top: 5px; }
        .add-btn:hover { border-color: #007bff; color: #007bff; background: #fff; }

        .file-btn { width: 100%; background: #fff; border: 2px dashed #ccc; color: #666; }
        .file-btn:hover { border-color: #007bff; color: #007bff; }

        /* Image Adjustments */
        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 0.85em; color: #555; }
        .slider-row input { flex: 1; }
        .slider-val { width: 35px; text-align: right; font-family: monospace; }

        /* Footer / Disclaimer */
        .sidebar-footer {
            margin-top: auto; padding-top: 20px; border-top: 1px solid #eee;
        }
        .disclaimer-text {
            font-size: 10px; color: #999; line-height: 1.4; text-align: justify;
            margin-bottom: 10px;
        }
        .stats-link {
            font-size: 10px; color: #bbb; text-align: center; cursor: pointer; text-decoration: none; display: block;
        }
        .stats-link:hover { text-decoration: underline; color: #007bff; }

        /* Canvas */
        .canvas-wrapper { flex: 1; position: relative; background: #222; overflow: hidden; cursor: crosshair; }
        .canvas-tip { position: absolute; bottom: 15px; right: 20px; color: rgba(255,255,255,0.4); font-size: 12px; pointer-events: none; user-select: none; }

        /* Modals (Report & Stats) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 210mm; height: 90vh; padding: 40px; 
            overflow-y: auto; border-radius: 4px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Stats Specific Modal */
        .stats-content { width: 600px; height: auto; max-height: 90vh; padding: 30px; }

        /* Print Styles */
        @media print {
            body > * { display: none !important; }
            .modal-overlay { display: block !important; position: absolute; background: white; top: 0; left: 0; width: 100%; height: auto; }
            .modal-content { width: 100%; height: auto; padding: 0; overflow: visible; box-shadow: none; }
            .no-print { display: none !important; }
            img { -webkit-print-color-adjust: exact; }
            #statsModal { display: none !important; }
        }

        /* Report Internal */
        .rpt-header { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .rpt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .rpt-box { border: 1px solid #ddd; padding: 10px; border-radius: 4px; break-inside: avoid; }
        .rpt-img { width: 100%; height: 250px; border: 1px solid #eee; margin-bottom: 10px; object-fit: contain; background: #fafafa; }
        .rpt-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px;}
        .rpt-table th, .rpt-table td { border: 1px solid #ccc; padding: 4px; text-align: center; }
        .rpt-summ { background: #f9f9f9; padding: 15px; border: 2px solid #333; border-radius: 6px; break-inside: avoid; }
        .rpt-extra-list { font-size: 11px; border-top:1px dashed #ccc; padding-top:5px; margin-top:5px;}
        .rpt-extra-row { display:flex; justify-content:space-between; padding:2px 0; color:#555;}
        
        /* Scale Label in Report */
        .rpt-scale-label { font-size: 11px; color: #1565c0; margin-bottom: 5px; font-weight: 600; border-bottom: 1px dashed #eee; padding-bottom: 3px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="app-title">üëÅÔ∏è Pupilometer Cloud</div>
    
    <div class="mode-tabs">
        <button class="tab-btn active" onclick="switchTab('light')" id="tab-light">‚òÄÔ∏è Light Room</button>
        <button class="tab-btn" onclick="switchTab('dark')" id="tab-dark">üåô Dark Room</button>
    </div>

    <div style="display:flex; align-items:center;">
        <div class="top-inputs">
             <!-- Default Calibration -->
            <div class="input-group" id="grp-ref-cornea">
                <span>Ref Cornea:</span>
                <input type="number" id="refCornea" value="12.0" step="0.1" class="input-box" onchange="recalcAll()"> mm
            </div>
            
            <!-- Custom Scale Controls -->
            <div class="scale-controls" id="scale-controls">
                <span>Scale:</span>
                <input type="number" id="customScaleVal" value="10" class="input-box" style="width:45px;" onchange="updateCustomScaleVal(this.value)"> mm
            </div>
            
            <!-- Custom Scale Toggle -->
            <button class="scale-toggle-btn" onclick="toggleCustomScale()" id="btn-toggle-scale" style="margin-left:10px;">
                üìè Custom Scale
            </button>
        </div>

        <button class="gen-btn" onclick="openReport()">üñ®Ô∏è Generate Report</button>
    </div>
</div>

<div class="main-container">
    <div class="sidebar">
        
        <!-- Summary -->
        <div class="panel summary-box">
            <div class="panel-label" style="color:#1565c0; border-bottom:none;">Diagnostic Summary</div>
            <div class="sum-row"><span>Dark Anisocoria:</span><span id="glb-dark">-</span></div>
            <div class="sum-row"><span>Light Anisocoria:</span><span id="glb-light">-</span></div>
            <div class="sum-row sum-final"><span>Diff (Dark - Light):</span><span id="glb-final">-</span></div>
        </div>

        <!-- Image Upload -->
        <div class="panel">
            <div class="panel-label">
                <span>1. Image Source</span>
                <span id="img-status" style="font-weight:400; color:#28a745; display:none;">‚óè Loaded</span>
            </div>
            <button class="tool-btn file-btn" onclick="document.getElementById('fileInput').click()">üìÇ Upload Photo / Paste (Ctrl+V)</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>

        <!-- Image Adjustments -->
        <div class="panel">
            <div class="panel-label">
                <span>2. Image Enhancer</span>
                <span style="font-weight:400; cursor:pointer; color:#007bff;" onclick="resetFilters()">Reset</span>
            </div>
            <div class="slider-row">
                <span>Brightness</span>
                <input type="range" id="slider-br" min="0" max="200" value="100" oninput="updateFilters()">
                <span class="slider-val" id="val-br">100</span>%
            </div>
            <div class="slider-row">
                <span>Contrast</span>
                <input type="range" id="slider-ct" min="0" max="200" value="100" oninput="updateFilters()">
                <span class="slider-val" id="val-ct">100</span>%
            </div>
        </div>

        <!-- Measurements -->
        <div class="panel">
            <div class="panel-label">3. Measurements (OD Right)</div>
            <div class="btn-grid">
                <div class="tool-wrapper">
                    <button class="tool-btn" onclick="setTool('r_cornea')" id="btn-r-cornea">Cornea</button>
                    <div class="val-display" id="res-r-cornea">-</div>
                </div>
                <div class="tool-wrapper">
                    <button class="tool-btn" onclick="setTool('r_pupil')" id="btn-r-pupil">Pupil</button>
                    <div class="val-display" id="res-r-pupil">-</div>
                </div>
            </div>
            
            <div class="panel-label" style="margin-top:10px;">4. Measurements (OS Left)</div>
            <div class="btn-grid">
                <div class="tool-wrapper">
                    <button class="tool-btn" onclick="setTool('l_cornea')" id="btn-l-cornea">Cornea</button>
                    <div class="val-display" id="res-l-cornea">-</div>
                </div>
                <div class="tool-wrapper">
                    <button class="tool-btn" onclick="setTool('l_pupil')" id="btn-l-pupil">Pupil</button>
                    <div class="val-display" id="res-l-pupil">-</div>
                </div>
            </div>
        </div>

        <!-- Extra Measurements -->
        <div class="panel">
            <div class="panel-label">5. Extra Measurements</div>
            <div id="extra-container" class="extra-list">
                <!-- Dynamic items go here -->
            </div>
            <button class="tool-btn add-btn" onclick="addExtra()">‚ûï Add Measurement</button>
        </div>

        <!-- Sidebar Footer: Disclaimer & Stats -->
        <div class="sidebar-footer">
            <div class="disclaimer-text">
                <strong>Disclaimer:</strong> This software is designed as an adjunctive tool for clinical reference and educational purposes only. It is not a certified medical device and has not been cleared by regulatory bodies for diagnostic use. Measurements should not be the sole basis for clinical decision-making. The user assumes all responsibility for data interpretation and patient care. Accuracy is dependent on image quality and calibration. This tool was developed by Jiaxing Wang, MD, PhD.
            </div>
            <div class="stats-link" onclick="openStats()">
                Usage Statistics ‚Ä¢ Total Visits: <span id="lbl-visits">Loading...</span>
            </div>
        </div>
    </div>

    <div class="canvas-wrapper" id="canvasContainer">
        <canvas id="mainCanvas"></canvas>
        <div class="canvas-tip">Scroll: Zoom ‚Ä¢ Right-Click: Pan ‚Ä¢ Left-Click: Measure</div>
    </div>
</div>

<!-- REPORT MODAL -->
<div class="modal-overlay" id="reportModal">
    <div class="modal-content">
        <div style="position:absolute; top:20px; right:20px;" class="no-print">
            <button class="gen-btn" onclick="window.print()" style="display:inline-flex;">üñ®Ô∏è Print PDF</button>
            <button class="tool-btn" onclick="document.getElementById('reportModal').style.display='none'" style="margin-left:10px;">Close</button>
        </div>

        <div class="rpt-header">
            <div>
                <h1 style="margin:0; color:#2c3e50;">Pupilometry Report</h1>
                <p style="margin:5px 0; color:#666;">Analysis Protocol: Dual Illumination</p>
            </div>
            <div style="text-align:right; font-size:14px; color:#555;">
                Generated: <span id="rpt-date"></span><br>
            </div>
        </div>

        <div class="rpt-grid">
            <!-- Light -->
            <div class="rpt-box">
                <h3 style="margin-top:0; border-bottom:1px solid #eee;">‚òÄÔ∏è Light Room</h3>
                <div id="rpt-scale-light" class="rpt-scale-label">Calibration: -</div>
                <img id="rpt-img-light" class="rpt-img">
                <table class="rpt-table">
                    <tr><th>Right Pupil (OD)</th><th>Left Pupil (OS)</th><th>Anisocoria</th></tr>
                    <tr><td id="rpt-l-r">-</td><td id="rpt-l-l">-</td><td id="rpt-l-diff" style="font-weight:bold">-</td></tr>
                </table>
                <div id="rpt-extra-light" class="rpt-extra-list"></div>
            </div>
            <!-- Dark -->
            <div class="rpt-box">
                <h3 style="margin-top:0; border-bottom:1px solid #eee;">üåô Dark Room</h3>
                <div id="rpt-scale-dark" class="rpt-scale-label">Calibration: -</div>
                <img id="rpt-img-dark" class="rpt-img">
                <table class="rpt-table">
                    <tr><th>Right Pupil (OD)</th><th>Left Pupil (OS)</th><th>Anisocoria</th></tr>
                    <tr><td id="rpt-d-r">-</td><td id="rpt-d-l">-</td><td id="rpt-d-diff" style="font-weight:bold">-</td></tr>
                </table>
                <div id="rpt-extra-dark" class="rpt-extra-list"></div>
            </div>
        </div>

        <div class="rpt-summ">
            <h3 style="margin-top:0; text-decoration:underline;">Diagnostic Conclusion</h3>
            <div class="sum-row" style="font-size:1.1em; margin-bottom:8px;">
                <span>Dark Anisocoria (|R-L|):</span> <span id="rpt-sum-dark">-</span>
            </div>
            <div class="sum-row" style="font-size:1.1em; margin-bottom:8px;">
                <span>Light Anisocoria (|R-L|):</span> <span id="rpt-sum-light">-</span>
            </div>
            <div class="sum-row" style="border-top:1px solid #ccc; padding-top:10px; font-size:1.4em; font-weight:800; color:#d32f2f;">
                <span>Difference (Dark - Light):</span> <span id="rpt-sum-final">-</span>
            </div>
            <p style="font-size:12px; color:#777; margin-top:15px; border-top:1px solid #ddd; padding-top:10px;">
                <strong>Disclaimer:</strong> This report is computer-generated for educational reference only. It does not constitute a medical diagnosis.
            </p>
        </div>
    </div>
</div>

<!-- STATS MODAL -->
<div class="modal-overlay" id="statsModal">
    <div class="modal-content stats-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0; color:#333;">Usage Statistics</h2>
            <button class="tool-btn" onclick="document.getElementById('statsModal').style.display='none'">Close</button>
        </div>
        <canvas id="statsChart" width="400" height="250"></canvas>
        <p style="font-size:11px; color:#999; margin-top:15px; text-align:center;">
            Data source: Local Session History (Client-side).
        </p>
    </div>
</div>

<script>
    // === APP STATE (INDEPENDENT SCALES) ===
    const STATE = {
        light: { 
            img: null, lines: {}, extras: [], filters: {b:100, c:100},
            useCustomScale: false, customScaleVal: 10
        },
        dark:  { 
            img: null, lines: {}, extras: [], filters: {b:100, c:100},
            useCustomScale: false, customScaleVal: 10
        }
    };
    let activeTab = 'light';
    let activeTool = null; 

    let cam = { x: 0, y: 0, zoom: 1 };
    let mouse = { x:0, y:0, down:false, drawing:false, dragStart:{x:0,y:0}, drawStart:{x:0,y:0} };

    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('canvasContainer');

    // === INIT ===
    function init() {
        window.addEventListener('resize', resize);
        resize();
        render();
        initStats();
    }
    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        render();
    }

    // === TABS & UI ===
    window.switchTab = function(mode) {
        activeTab = mode;
        activeTool = null;
        
        // Update UI Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + mode).classList.add('active');
        
        // Load Data for Tab
        const data = STATE[activeTab];
        
        // Update Image Status
        document.getElementById('img-status').style.display = data.img ? 'inline' : 'none';
        
        // Restore Filters
        document.getElementById('slider-br').value = data.filters.b;
        document.getElementById('slider-ct').value = data.filters.c;
        updateSliderLabels();

        // Restore Custom Scale UI for this specific tab
        updateScaleUI();

        // Fit Camera
        if(data.img) fitCam();
        
        // Reset Tools UI
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.extra-btn-measure').forEach(b => b.classList.remove('active'));

        // Render Sidebar Extra Items
        renderSidebarExtras();

        recalcAll();
        render();
    }

    function updateScaleUI() {
        const data = STATE[activeTab];
        const btn = document.getElementById('btn-toggle-scale');
        const controls = document.getElementById('scale-controls');
        const refInput = document.getElementById('grp-ref-cornea');
        
        document.getElementById('customScaleVal').value = data.customScaleVal;

        if(data.useCustomScale) {
            btn.classList.add('active');
            controls.style.display = 'flex';
            refInput.style.opacity = '0.5';
        } else {
            btn.classList.remove('active');
            controls.style.display = 'none';
            refInput.style.opacity = '1';
        }
    }

    // === SCALE TOGGLE LOGIC (INDEPENDENT) ===
    window.toggleCustomScale = function() {
        const data = STATE[activeTab];
        data.useCustomScale = !data.useCustomScale;
        
        updateScaleUI();

        if(data.useCustomScale) {
            // Auto start drawing if enabled
            setTool('ruler');
        } else {
            if(activeTool === 'ruler') activeTool = null;
        }
        recalcAll();
        render();
    }

    window.updateCustomScaleVal = function(val) {
        STATE[activeTab].customScaleVal = parseFloat(val) || 10;
        recalcAll();
        render(); // Re-render to update the persistent text label on canvas
    }

    // === IMAGE HANDLING ===
    document.getElementById('fileInput').addEventListener('change', e => loadImg(e.target.files[0]));
    document.addEventListener('paste', e => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for(let item of items) if(item.type.startsWith('image')) loadImg(item.getAsFile());
    });

    function loadImg(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                // Initialize default state for new image
                STATE[activeTab].img = img;
                STATE[activeTab].lines = {}; 
                STATE[activeTab].extras = []; 
                STATE[activeTab].filters = {b:100, c:100};
                // Keep the scale setting (useCustomScale) as preference, don't reset it
                // but if we do want to reset, we would do it here. Let's keep it persistent.
                
                document.getElementById('slider-br').value = 100;
                document.getElementById('slider-ct').value = 100;
                updateSliderLabels();
                
                document.getElementById('img-status').style.display = 'inline';
                renderSidebarExtras();
                fitCam();
                recalcAll();
                render();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function fitCam() {
        const img = STATE[activeTab].img;
        if(img) {
            cam.zoom = Math.min((canvas.width*0.9)/img.width, (canvas.height*0.9)/img.height);
            cam.x = (canvas.width - img.width * cam.zoom)/2;
            cam.y = (canvas.height - img.height * cam.zoom)/2;
        }
    }

    // === FILTERS ===
    window.updateFilters = function() {
        const b = document.getElementById('slider-br').value;
        const c = document.getElementById('slider-ct').value;
        STATE[activeTab].filters = { b: parseInt(b), c: parseInt(c) };
        updateSliderLabels();
        render();
    }
    window.resetFilters = function() {
        document.getElementById('slider-br').value = 100;
        document.getElementById('slider-ct').value = 100;
        updateFilters();
    }
    function updateSliderLabels() {
        document.getElementById('val-br').innerText = STATE[activeTab].filters.b;
        document.getElementById('val-ct').innerText = STATE[activeTab].filters.c;
    }

    // === EXTRA MEASUREMENTS LOGIC ===
    window.addExtra = function() {
        const id = 'ex_' + Date.now();
        STATE[activeTab].extras.push({
            id: id,
            name: '', 
            line: null
        });
        renderSidebarExtras();
        setTool(id);
    }

    window.deleteExtra = function(id) {
        STATE[activeTab].extras = STATE[activeTab].extras.filter(x => x.id !== id);
        if(activeTool === id) activeTool = null;
        renderSidebarExtras();
        render();
    }

    window.updateExtraName = function(id, val) {
        const item = STATE[activeTab].extras.find(x => x.id === id);
        if(item) item.name = val;
    }

    function renderSidebarExtras() {
        const container = document.getElementById('extra-container');
        container.innerHTML = '';
        const list = STATE[activeTab].extras;

        list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'extra-item';
            div.innerHTML = `
                <input type="text" class="extra-name-input" placeholder="Name..." value="${item.name}" onchange="updateExtraName('${item.id}', this.value)">
                <button class="extra-btn-measure ${activeTool===item.id?'active':''}" onclick="setTool('${item.id}')">Measure</button>
                <div class="extra-val" id="val-${item.id}">-</div>
                <div class="extra-btn-del" onclick="deleteExtra('${item.id}')">&times;</div>
            `;
            container.appendChild(div);
        });
        recalcAll();
    }

    // === CANVAS & TOOLS ===
    const toWorld = (sx, sy) => ({ x: (sx - cam.x)/cam.zoom, y: (sy - cam.y)/cam.zoom });
    const dist = (p1, p2) => Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));

    window.setTool = function(tool) {
        if(!STATE[activeTab].img) { alert("Please upload an image first."); return; }
        activeTool = tool;
        
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.extra-btn-measure').forEach(b => b.classList.remove('active'));

        if (tool.startsWith('ex_')) {
            renderSidebarExtras(); 
        } else {
            let btnId = (tool === 'ruler') ? 'btn-ruler' : 'btn-' + tool.replace('_','-');
            if(document.getElementById(btnId)) document.getElementById(btnId).classList.add('active');
        }
    }

    canvas.addEventListener('mousedown', e => {
        if(e.button === 2 || e.shiftKey) { 
            mouse.down = true; mouse.drawing = false;
            mouse.dragStart = { x: e.offsetX - cam.x, y: e.offsetY - cam.y };
        } else if(e.button === 0 && activeTool) { 
            mouse.down = true; mouse.drawing = true;
            mouse.drawStart = toWorld(e.offsetX, e.offsetY);
            mouse.curr = mouse.drawStart;
        }
    });
    canvas.addEventListener('mousemove', e => {
        if(mouse.down && !mouse.drawing) {
            cam.x = e.offsetX - mouse.dragStart.x;
            cam.y = e.offsetY - mouse.dragStart.y;
            render();
        } else if(mouse.down && mouse.drawing) {
            mouse.curr = toWorld(e.offsetX, e.offsetY);
            render();
        }
    });
    canvas.addEventListener('mouseup', () => {
        if(mouse.drawing && dist(mouse.drawStart, mouse.curr) > 0) {
            const lineObj = { p1: mouse.drawStart, p2: mouse.curr };
            if (activeTool.startsWith('ex_')) {
                const item = STATE[activeTab].extras.find(x => x.id === activeTool);
                if(item) item.line = lineObj;
                renderSidebarExtras(); 
            } else {
                STATE[activeTab].lines[activeTool] = lineObj;
            }
            recalcAll();
        }
        mouse.down = false; mouse.drawing = false;
        render(); 
    });
    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        const d = e.deltaY > 0 ? 0.9 : 1.1;
        const wx = (e.offsetX - cam.x) / cam.zoom;
        const wy = (e.offsetY - cam.y) / cam.zoom;
        cam.zoom *= d;
        cam.x = e.offsetX - wx * cam.zoom;
        cam.y = e.offsetY - wy * cam.zoom;
        render();
    });
    canvas.addEventListener('contextmenu', e => e.preventDefault());

    // === CALCULATION LOGIC (PER DATA OBJECT) ===
    function getPxPerMm(data) {
        // 1. Custom Scale (Local to this data object)
        if (data.useCustomScale && data.lines.ruler) {
            const rulerLen = dist(data.lines.ruler.p1, data.lines.ruler.p2);
            // Use the locally saved custom value
            const userMm = data.customScaleVal || 10;
            if (rulerLen > 0) return { ratio: rulerLen / userMm, type: 'ruler', refMm: userMm, source: 'Custom Scale' };
        }
        
        // 2. Cornea Default (Fallback)
        if (!data.useCustomScale) {
            const defCornea = parseFloat(document.getElementById('refCornea').value) || 12.0;
            if (data.lines.r_cornea) {
                const cLen = dist(data.lines.r_cornea.p1, data.lines.r_cornea.p2);
                if (cLen > 0) return { ratio: cLen / defCornea, type: 'cornea', refMm: defCornea, source: 'OD Cornea' };
            }
            if (data.lines.l_cornea) {
                const cLen = dist(data.lines.l_cornea.p1, data.lines.l_cornea.p2);
                if (cLen > 0) return { ratio: cLen / defCornea, type: 'cornea', refMm: defCornea, source: 'OS Cornea' };
            }
        }

        return { ratio: 0, type: 'none', refMm: 0, source: 'None' };
    }

    function calcResults(data) {
        const cal = getPxPerMm(data);
        
        const getMm = (line) => {
            if (!line) return 0;
            const d = dist(line.p1, line.p2);
            if (cal.ratio > 0) return d / cal.ratio;
            return 0;
        };

        const r = getMm(data.lines.r_pupil);
        const l = getMm(data.lines.l_pupil);
        const diff = (r>0 && l>0) ? Math.abs(r-l) : null;
        
        const rc = getMm(data.lines.r_cornea);
        const lc = getMm(data.lines.l_cornea);

        return { r, l, diff, rc, lc, cal };
    }

    window.recalcAll = function() {
        const localData = STATE[activeTab];
        const local = calcResults(localData);
        const light = calcResults(STATE.light);
        const dark = calcResults(STATE.dark);

        const fmt = n => n>0 ? n.toFixed(2)+' mm' : '-';
        
        // Update Sidebar
        document.getElementById('res-r-cornea').innerText = fmt(local.rc);
        document.getElementById('res-r-pupil').innerText = fmt(local.r);
        document.getElementById('res-l-cornea').innerText = fmt(local.lc);
        document.getElementById('res-l-pupil').innerText = fmt(local.l);

        // Update Extra Values
        if(local.cal.ratio > 0) {
            localData.extras.forEach(item => {
                const el = document.getElementById('val-'+item.id);
                if(el && item.line) {
                    const len = dist(item.line.p1, item.line.p2) / local.cal.ratio;
                    el.innerText = len.toFixed(2) + ' mm';
                } else if (el) {
                    el.innerText = '-';
                }
            });
        }

        // Global Panel
        document.getElementById('glb-dark').innerText = dark.diff!==null ? dark.diff.toFixed(2)+' mm' : '-';
        document.getElementById('glb-light').innerText = light.diff!==null ? light.diff.toFixed(2)+' mm' : '-';
        
        if(dark.diff!==null && light.diff!==null) {
            const final = dark.diff - light.diff;
            const sign = final > 0 ? "+" : "";
            document.getElementById('glb-final').innerText = sign + final.toFixed(2) + ' mm';
        } else {
            document.getElementById('glb-final').innerText = '-';
        }
    }

    // === RENDER ===
    function render() {
        ctx.clearRect(0,0,canvas.width, canvas.height);
        const data = STATE[activeTab];
        const cal = getPxPerMm(data);
        
        ctx.save();
        ctx.translate(cam.x, cam.y);
        ctx.scale(cam.zoom, cam.zoom);

        if(data.img) {
            ctx.save();
            ctx.filter = `brightness(${data.filters.b}%) contrast(${data.filters.c}%)`;
            ctx.drawImage(data.img, 0, 0);
            ctx.restore();
        } else {
            ctx.fillStyle = "#ccc"; ctx.font = "20px sans-serif"; ctx.textAlign="center";
            ctx.fillText("Please Upload / Paste Image", canvas.width/2/cam.zoom, canvas.height/2/cam.zoom);
        }

        const drawLabel = (text, x, y, color) => {
            ctx.save();
            const fontSize = 14 / cam.zoom;
            ctx.font = `bold ${fontSize}px sans-serif`;
            const width = ctx.measureText(text).width;
            const pad = 4 / cam.zoom;
            ctx.fillStyle = "rgba(0,0,0,0.6)";
            ctx.fillRect(x - width/2 - pad, y - fontSize, width + pad*2, fontSize + pad*2);
            ctx.fillStyle = "#fff"; ctx.textAlign = "center";
            ctx.fillText(text, x, y);
            ctx.restore();
        }

        const drawLine = (l, c) => {
            ctx.beginPath(); ctx.moveTo(l.p1.x, l.p1.y); ctx.lineTo(l.p2.x, l.p2.y);
            ctx.strokeStyle = c; ctx.lineWidth = 2/cam.zoom; ctx.stroke();
            ctx.fillStyle = c; const r = 3/cam.zoom;
            ctx.beginPath(); ctx.arc(l.p1.x, l.p1.y, r, 0, 6.28); ctx.fill();
            ctx.beginPath(); ctx.arc(l.p2.x, l.p2.y, r, 0, 6.28); ctx.fill();
        }

        // Draw Standard Lines
        Object.entries(data.lines).forEach(([k, l]) => { 
            if(l) {
                let color = '#28a745'; 
                if (k.includes('pupil')) color = '#e74c3c';
                if (k === 'ruler') color = '#ffc107';

                drawLine(l, color);

                // PERSISTENT SCALE LABEL (Only if enabled in this tab)
                if (k === 'ruler' && data.useCustomScale) {
                     drawLabel(`Scale: ${data.customScaleVal}mm`, (l.p1.x+l.p2.x)/2, (l.p1.y+l.p2.y)/2 - 15/cam.zoom, color);
                }
            }
        });

        // Draw Extra Lines
        data.extras.forEach(item => {
            if (item.line) {
                const color = '#17a2b8'; 
                drawLine(item.line, color);
            }
        });

        // Draw Active Line
        if(mouse.drawing) {
            let color = '#fff';
            if (activeTool === 'ruler') color = '#ffc107';
            else if (activeTool.startsWith('ex_')) color = '#17a2b8';
            else if (activeTool.includes('pupil')) color = '#e74c3c';
            else if (activeTool.includes('cornea')) color = '#28a745';

            const currLine = {p1:mouse.drawStart, p2:mouse.curr};
            drawLine(currLine, color);

            // Real-time Label
            const lenPx = dist(mouse.drawStart, mouse.curr);
            let txt = "";
            if (activeTool === 'ruler') txt = "Set Scale";
            else if (cal.ratio > 0) txt = (lenPx / cal.ratio).toFixed(2) + 'mm';
            else if (!data.useCustomScale && activeTool.includes('cornea')) txt = "Set Ref";
            
            if(txt) drawLabel(txt, (mouse.drawStart.x+mouse.curr.x)/2, (mouse.drawStart.y+mouse.curr.y)/2 - 10/cam.zoom, color);
        }

        ctx.restore();
    }

    // === REPORT ===
    window.openReport = function() {
        document.getElementById('rpt-date').innerText = new Date().toLocaleDateString();
        
        fillRptData('light');
        fillRptData('dark');

        const l = calcResults(STATE.light);
        const d = calcResults(STATE.dark);
        const fmt = n => n!==null ? n.toFixed(2)+' mm' : '-';
        document.getElementById('rpt-sum-dark').innerText = fmt(d.diff);
        document.getElementById('rpt-sum-light').innerText = fmt(l.diff);
        
        if(d.diff!==null && l.diff!==null) {
            const final = d.diff - l.diff;
            const sign = final > 0 ? "+" : "";
            document.getElementById('rpt-sum-final').innerText = sign + final.toFixed(2) + ' mm';
        } else {
            document.getElementById('rpt-sum-final').innerText = '-';
        }

        document.getElementById('reportModal').style.display = 'flex';
    }

    function fillRptData(key) {
        const data = STATE[key];
        const res = calcResults(data);
        
        let scaleTxt = "Calibration: None";
        if (res.cal.type === 'ruler') {
            scaleTxt = `Calibration: Custom Scale (${res.cal.refMm}mm)`;
        } else if (res.cal.type === 'cornea') {
            scaleTxt = `Calibration: ${res.cal.source} = ${res.cal.refMm}mm`;
        }
        document.getElementById(`rpt-scale-${key}`).innerText = scaleTxt;

        const fmt = n => n>0 ? n.toFixed(2)+' mm' : '-';
        document.getElementById(`rpt-${key.charAt(0)}-r`).innerText = fmt(res.r);
        document.getElementById(`rpt-${key.charAt(0)}-l`).innerText = fmt(res.l);
        document.getElementById(`rpt-${key.charAt(0)}-diff`).innerText = res.diff!==null ? res.diff.toFixed(2)+' mm' : '-';

        const extraContainer = document.getElementById(`rpt-extra-${key}`);
        extraContainer.innerHTML = '';
        if (data.extras.length > 0 && res.cal.ratio > 0) {
            data.extras.forEach(item => {
                if(item.line) {
                    const val = dist(item.line.p1, item.line.p2) / res.cal.ratio;
                    const row = document.createElement('div');
                    row.className = 'rpt-extra-row';
                    const dName = item.name ? item.name : "Measurement";
                    row.innerHTML = `<span>${dName}</span><span>${val.toFixed(2)} mm</span>`;
                    extraContainer.appendChild(row);
                }
            });
        }

        const imgEl = document.getElementById(`rpt-img-${key}`);
        if(data.img) {
            const tC = document.createElement('canvas');
            tC.width = data.img.width; tC.height = data.img.height;
            const tCtx = tC.getContext('2d');
            
            tCtx.filter = `brightness(${data.filters.b}%) contrast(${data.filters.c}%)`;
            tCtx.drawImage(data.img, 0, 0);
            tCtx.filter = 'none';

            tCtx.lineWidth = Math.max(3, data.img.width/400);
            
            Object.entries(data.lines).forEach(([k,l])=>{
                if(l) {
                    let c = '#28a745';
                    if(k.includes('pupil')) c = '#e74c3c';
                    if(k === 'ruler') c = '#ffc107';
                    drawRptLine(tCtx, l, c);
                }
            });

            data.extras.forEach(item => {
                if(item.line) drawRptLine(tCtx, item.line, '#17a2b8');
            });

            imgEl.src = tC.toDataURL('image/jpeg', 0.85);
            imgEl.style.display = 'block';
        } else {
            imgEl.style.display = 'none';
        }
    }

    function drawRptLine(ctx, l, c) {
        ctx.beginPath(); ctx.moveTo(l.p1.x, l.p1.y); ctx.lineTo(l.p2.x, l.p2.y);
        ctx.strokeStyle=c; ctx.stroke();
        ctx.fillStyle=c;
        ctx.beginPath(); ctx.arc(l.p1.x,l.p1.y,ctx.lineWidth*2,0,6.28); ctx.fill();
        ctx.beginPath(); ctx.arc(l.p2.x,l.p2.y,ctx.lineWidth*2,0,6.28); ctx.fill();
    }

    // === STATS ===
    let chartInstance = null;
    let visitCount = 0;
    function initStats() {
        let saved = localStorage.getItem('pupil_visits_v4'); 
        visitCount = saved ? parseInt(saved) + 1 : 1; 
        localStorage.setItem('pupil_visits_v4', visitCount);
        document.getElementById('lbl-visits').innerText = visitCount.toLocaleString();
    }
    window.openStats = function() {
        document.getElementById('statsModal').style.display = 'flex';
        renderChart();
    }
    function renderChart() {
        if(chartInstance) chartInstance.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        const labels = []; const dataPoints = [];
        const historicalMax = visitCount > 10 ? Math.floor(visitCount / 5) : 0;
        for(let i=6; i>=1; i--) { 
            const d = new Date(); d.setDate(d.getDate() - i);
            labels.push(d.toLocaleDateString('en-US', {month:'short', day:'numeric'}));
            dataPoints.push(Math.floor(Math.random() * historicalMax));
        }
        labels.push("Today");
        dataPoints.push(Math.max(1, Math.floor(visitCount * 0.2)));

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Sessions', data: dataPoints, backgroundColor: 'rgba(0, 123, 255, 0.5)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 }] },
            options: { responsive: true, plugins: { legend: {display:false}, title: { display: true, text: 'Activity Overview (Last 7 Days)' } }, scales: { y: { beginAtZero: true, title: {display:true, text:'Sessions'} }, x: { title: {display:true, text:'Date'} } } }
        });
    }

    init();
</script>
</body>
</html>